// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Admin {
  id           String   @id @default(uuid())
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

enum AccountType {
  bank
  cash
  credit_card
  investment
}

enum TransactionType {
  income
  expense
  transfer
}

enum EntryType {
  income
  expense
  transfer
}

model Entry {
  id              String      @id @default(uuid())

  // Core type
  entryType       EntryType
  date            DateTime

  // Money & text
  amount          Decimal     @db.Decimal(14, 2)
  description     String
  notes           String?

  // Primary account (always required)
  accountId       String
  account         Account     @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Category (expense / income only)
  categoryId      String?
  category        Category?   @relation(fields: [categoryId], references: [id])

  // Interest → loan linking (optional)
  linkedLoanId    String?
  linkedLoan      Account?    @relation("EntryLoanLink", fields: [linkedLoanId], references: [id])

  // Transfer support
  transferGroupId String?     // same UUID for both sides of a transfer
  counterAccountId String?    // from ↔ to account

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([entryType])
  @@index([date])
  @@index([accountId])
  @@index([categoryId])
  @@index([transferGroupId])
}


model Account {
  id              String        @id @default(uuid())
  accountname     String
  accountType     AccountType
  description     String?
  openingBalance  Decimal       @db.Decimal(14, 2)
  currentBalance  Decimal?       @db.Decimal(14, 2)

  transactions    Transaction[]

    // ✅ ADD THESE (non-breaking)
  entries         Entry[]
  loanEntries     Entry[] @relation("EntryLoanLink")

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}


model Transaction {
  id              String           @id @default(uuid())
  accountId       String
  account         Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)

  description     String
  amount          Decimal          @db.Decimal(14, 2)
  transactionType TransactionType
  date            DateTime

  createdAt       DateTime         @default(now())
}


model Category {
  id        String   @id @default(uuid())
  name      String
  type      CategoryType

  parentId  String?
  parent    Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")

    // ✅ ADD THIS
  entries   Entry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([parentId])
}

enum CategoryType {
  expense
  income
}


enum LoanType {
  GIVEN
  TAKEN
}

enum InterestType {
  SIMPLE
  COMPOUND
}

enum RepaymentType {
  PRINCIPAL
  INTEREST
}

model Loan {
  id            String        @id @default(uuid())

  personName    String
  loanType      LoanType
  principal     Decimal       @db.Decimal(14,2)

  interestRate  Decimal       @db.Decimal(5,2)
  interestType  InterestType

  startDate     DateTime
  notes         String?

  repayments    LoanRepayment[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}


model LoanRepayment {
  id            String         @id @default(uuid())
  loanId        String

  amount        Decimal        @db.Decimal(14,2)
  repaymentType RepaymentType
  date          DateTime
  notes         String?

  createdAt     DateTime       @default(now())

  loan          Loan           @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([loanId])
}
